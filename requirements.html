<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ProBox Sales Dashboard ‚Äî Requirements</title>
    <style>
      :root {
        --bg: #0b0f17;
        --panel: #0f172a;
        --panel2: #0b1224;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.08);
        --accent: #60a5fa;
        --good: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --chip: rgba(96, 165, 250, 0.12);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        background: radial-gradient(1200px 600px at 20% -10%, rgba(96, 165, 250, 0.18), transparent),
          radial-gradient(900px 500px at 90% 10%, rgba(34, 197, 94, 0.12), transparent),
          var(--bg);
        color: var(--text);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      header {
        border-bottom: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(10px);
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 18px;
      }
      h1 {
        margin: 0 0 6px 0;
        font-size: 22px;
        letter-spacing: 0.2px;
      }
      .meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--chip);
        color: var(--text);
        font-size: 12px;
      }
      .chip code {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text);
      }
      .copybtn {
        font-family: var(--sans);
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.45);
        color: var(--text);
        cursor: pointer;
        white-space: nowrap;
      }
      .copybtn:hover {
        border-color: rgba(96, 165, 250, 0.45);
      }
      .copyrow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 6px;
      }
      .copyrow p {
        margin: 0;
      }
      main {
        padding: 22px 0 44px 0;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      section {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(15, 23, 42, 0.8), rgba(11, 18, 36, 0.85));
        overflow: hidden;
      }
      section h2 {
        margin: 0;
        padding: 14px 16px;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .body {
        padding: 14px 16px 16px 16px;
      }
      p {
        margin: 0 0 10px 0;
        color: var(--text);
        line-height: 1.55;
      }
      ul {
        margin: 10px 0 0 0;
        padding-left: 18px;
        color: var(--text);
        line-height: 1.55;
      }
      li {
        margin: 6px 0;
      }
      code,
      pre {
        font-family: var(--mono);
      }
      pre {
        margin: 10px 0 0 0;
        padding: 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.7);
        border-radius: 10px;
        overflow-x: auto;
        font-size: 12px;
        color: var(--text);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border-bottom: 1px solid var(--border);
        padding: 10px 8px;
        text-align: left;
        vertical-align: top;
        font-size: 13px;
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .status {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 12px;
        font-weight: 600;
      }
      .todo {
        background: rgba(245, 158, 11, 0.12);
        color: #fbbf24;
      }
      .inprogress {
        background: rgba(96, 165, 250, 0.12);
        color: #93c5fd;
      }
      .done {
        background: rgba(34, 197, 94, 0.12);
        color: #86efac;
      }
      .note {
        color: var(--muted);
        font-size: 12px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .k {
        color: var(--muted);
      }
      .mono {
        font-family: var(--mono);
      }
    </style>
  </head>
  <body>
    <script>
      function copyTextFromPre(preId, btn) {
        const pre = document.getElementById(preId);
        if (!pre) return;
        const text = pre.innerText || pre.textContent || "";
        navigator.clipboard.writeText(text).then(
          () => {
            const old = btn.textContent;
            btn.textContent = "Copied";
            setTimeout(() => (btn.textContent = old), 900);
          },
          () => {
            // fallback: select text
            const range = document.createRange();
            range.selectNodeContents(pre);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }
        );
      }
    </script>
    <header>
      <div class="wrap">
        <h1>ProBox Sales Dashboard ‚Äî Requirements (Internal)</h1>
        <div class="small">
          Purpose: capture the complete requirements + build task list + ‚Äúdon‚Äôt forget‚Äù notes in one
          place. Canonical initiative folder:
          <span class="mono">/Users/mpatil/ProBox/Dashboard</span>
        </div>
        <div class="meta" aria-label="metadata">
          <span class="chip"><span class="k">Status</span> <code>building - E2E writes working</code></span>
          <span class="chip"><span class="k">Orchestrator</span> <code>n8n</code></span>
          <span class="chip"><span class="k">Data/UI</span> <code>Airtable + Interfaces</code></span>
          <span class="chip"><span class="k">Email (MVP)</span> <code>Gmail</code></span>
          <span class="chip"><span class="k">Email (Prod)</span> <code>Outlook/M365</code></span>
          <span class="chip"><span class="k">Read-only</span> <code>yes</code></span>
          <span class="chip"><span class="k">Folder</span> <code>/Users/mpatil/ProBox/Dashboard</code></span>
        </div>
      </div>
    </header>

    <main class="wrap">
      <!-- =========================================================
           QUICK COMMANDS + INDEX (keep at the top)
           ========================================================= -->
      <section id="commands" style="margin-bottom: 14px">
        <h2>
          Daily Commands (Copy/Paste)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <div class="copyrow">
            <p><strong>Dash-resume</strong> (paste at the start of a session):</p>
            <button class="copybtn" type="button" onclick="copyTextFromPre('cmd-dash-resume', this)">Copy</button>
          </div>
          <pre id="cmd-dash-resume">Dash-resume

Follow these steps:
1) Read /Users/mpatil/ProBox/Dashboard/requirements.html
2) Re-sync context from:
   - Implementation Status &amp; Summary
   - Canonical Processing Architecture (Holistic)
   - Build Task List
3) Ask 1‚Äì3 clarifying questions only if required to proceed
4) Continue from the "üöß In Progress / Next Steps" list and update statuses as you complete items

CRITICAL INSTRUCTION STYLE:
- Give instructions as if explaining to a 10-year-old (simple, clear, step-by-step)
- Break instructions into small chunks (max 3 steps at a time)
- Wait for feedback before proceeding to next chunk
- Never give a full list of instructions at once</pre>

          <div class="copyrow">
            <p><strong>Dash-close</strong> (paste before you stop for the day):</p>
            <button class="copybtn" type="button" onclick="copyTextFromPre('cmd-dash-close', this)">Copy</button>
          </div>
          <pre id="cmd-dash-close">Dash-close

Before stopping, update /Users/mpatil/ProBox/Dashboard/requirements.html with:
1) What changed today (bullets)
1.1) Add a new entry to the ‚ÄúDaily Change Log‚Äù section (date-stamped)
2) Current n8n workflow topology (node list in order) + which nodes were added/renamed
3) Current Airtable schema (only if fields changed)
4) What is working end-to-end (explicit)
5) What is NOT working / blockers (explicit)
6) Next steps for tomorrow (3‚Äì7 bullets)
7) Update task statuses in ‚ÄúBuild Task List‚Äù</pre>

          <p class="note">
            These commands are designed to be copy/paste instructions so the assistant can ‚Äúrevive‚Äù
            all context from this document and then continue cleanly.
          </p>
        </div>
      </section>

      <section id="index" style="margin-bottom: 14px">
        <h2>
          Index
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <ul>
            <li><a href="#commands">Daily Commands (Copy/Paste)</a></li>
            <li><a href="#index">Index</a></li>
            <li><a href="#changelog">Daily Change Log</a></li>
            <li><a href="#summary">Requirement Summary</a></li>
            <li><a href="#status">Implementation Status &amp; Summary</a></li>
            <li><a href="#stages">Canonical Sales Stages (1‚Äì14)</a></li>
            <li><a href="#airtable">Airtable Data Model</a></li>
            <li><a href="#workflow">n8n Workflow</a></li>
            <li><a href="#cumulative">Cumulative Updates (Core Behavior)</a></li>
            <li><a href="#prompt">Prompt Contract</a></li>
            <li><a href="#tasks">Build Task List</a></li>
            <li><a href="#notes">Things to Remember</a></li>
          </ul>
        </div>
      </section>

      <section id="changelog" style="margin-bottom: 14px">
        <h2>
          Daily Change Log
          <span class="status inprogress">in progress</span>
        </h2>
        <div class="body">
          <p class="note">
            Add one entry per day on <strong>Dash-close</strong>. This is the fastest way to ‚Äúrevive‚Äù full context later.
          </p>
          <table aria-label="daily-change-log">
            <thead>
              <tr>
                <th style="width: 140px">Date</th>
                <th>Changes (what/why)</th>
                <th style="width: 240px">n8n Nodes / Schema touched</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="mono">2026-01-10</span></td>
                <td>
                  - Completed workflow structure end-to-end: Gmail Trigger ‚Üí Build Email Packet ‚Üí Code - Check Dedupe ‚Üí Message a model ‚Üí Parse LLM JSON ‚Üí If (stop check) ‚Üí Prepare Airtable Fields ‚Üí Search records ‚Üí Code - Preserve Fields ‚Üí Record Exists ‚Üí (Create Quote OR Merge/Append Stage Updates ‚Üí Update Quote) ‚Üí Code - Mark Processed<br />
                  - Added Code - Preserve Fields node to preserve data from Prepare Airtable Fields when Search records finds nothing (so Create Quote can access the prepared fields)<br />
                  - Updated Message a model prompt to extract numeric quote identifiers (e.g., "330519" not "INQ 330519") and added detailed stage detection hints<br />
                  - Updated requirements document to reflect numeric-only quote identifier format<br />
                  - Workflow structure is complete and all nodes are connected correctly<br />
                  - Message a model still not extracting quote identifiers (returns empty string) - prompt may need further tuning or email format investigation<br />
                  - Create Quote field mappings not finished (needs all fields mapped once quote extraction works)
                </td>
                <td>
                  - Nodes added: Code - Check Dedupe, Code - Preserve Fields, Code - Mark Processed<br />
                  - Nodes renamed: "Build Email Packet" (was Code), "Parse LLM JSON" (was Code), "Prepare Airtable Fields " (trailing space in name), "Record Exists" (was If), "Merge/Append Stage Updates" (was Code), "Create Quote", "Update Quote "<br />
                  - Search records: alwaysOutputData: true (enabled in Settings)<br />
                  - Typecast: ON in all Airtable nodes (Create Quote, Update Quote)
                </td>
              </tr>
              <tr>
                <td><span class="mono">2026-01-12</span></td>
                <td>
                  - Fixed duplicate record creation issue: Removed direct connection from "Search records" to "Record Exists" - now Record Exists only receives data from "Preserve Fields"<br />
                  - Updated "Prepare Airtable Fields" code to output ALL 14 stage fields (even if empty) and set ReceivedAt for new records<br />
                  - Updated Message a model prompt to remove incorrect "INQ" prefix assumption - quote identifiers are numeric-only, can appear anywhere in email<br />
                  - Enhanced prompt with better context understanding for stage detection (e.g., "here is invoice" when providing quote = Quotation Preparation, not Invoicing)<br />
                  - Updated requirements document with exact node names and Preserve Fields code to prevent future confusion<br />
                  - Fixed "Record Exists" IF node: Enabled "Convert types where required" to handle string-to-boolean conversion<br />
                  - Fixed "Preserve Fields" code to correctly extract id from Airtable record structure<br />
                  - Workflow now correctly creates single record (no duplicates) when quote doesn't exist<br />
                  - BLOCKER: Create Quote node still has incorrect field mappings - showing literal expressions like {{$json.primary_qu... instead of values<br />
                  - BLOCKER: Message a model prompt needs further refinement - not extracting quote "551308" from email thread
                </td>
                <td>
                  - No new nodes added<br />
                  - Connection removed: "Search records" ‚Üí "Record Exists" (duplicate path)<br />
                  - "Record Exists" IF node: "Convert types where required" = ON<br />
                  - "Prepare Airtable Fields" code: Added ReceivedAt and all 14 stage fields to output<br />
                  - "Preserve Fields" code: Fixed to handle Airtable record structure correctly<br />
                  - Message a model prompt: Removed INQ prefix assumption, improved stage detection context
                </td>
              </tr>
              <tr>
                <td><span class="mono">YYYY-MM-DD</span></td>
                <td>
                  - What changed today<br />
                  - Why we changed it<br />
                  - What is now working end-to-end<br />
                  - What is still broken / next blocker
                </td>
                <td>
                  - Nodes added/renamed<br />
                  - Airtable fields added/changed<br />
                  - Any important config (Typecast ON, etc.)
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- =========================================================
           OVERVIEW
           ========================================================= -->
      <div class="grid">
        <section id="summary">
          <h2>
            Requirement Summary
            <span class="status done">locked</span>
          </h2>
          <div class="body">
            <p>
              Build an internal, read-only dashboard that shows a real-time snapshot of every active
              quote and its current stage in the sales pipeline, automatically updated by reading
              the shared sales inbox <span class="mono">sales@proboxinc.com</span>.
            </p>
            <ul>
              <li><strong>Primary data source</strong>: email inbox content (human-written emails and attachments).</li>
              <li><strong>Automation</strong>: AI/LLM interprets each email and generates structured stage updates.</li>
              <li><strong>UI</strong>: Airtable grid (no drill-down required) + optional Airtable Interfaces later.</li>
              <li><strong>No links back from dashboard</strong>: not required for v1.</li>
              <li><strong>Extracted details</strong>: optional; stage cells contain the best extracted stage update text.</li>
              <li><strong>Migration</strong>: MVP uses Gmail; production target is Outlook/M365.</li>
            </ul>
          </div>
        </section>

        <section id="status">
          <h2>
            Implementation Status &amp; Summary
            <span class="status inprogress">in progress</span>
          </h2>
          <div class="body">
            <p class="note">
              This section is the canonical ‚Äúwhere we are today‚Äù. Keep it updated on every <strong>Dash-close</strong>.
            </p>
            <!-- Existing Implementation Status & Summary content remains below in the document -->
            <p class="note">
              Jump: <a href="#tasks">Build Task List</a>
            </p>
          </div>
        </section>
      </div>

      <!-- =========================================================
           STAGES + DATA MODEL
           ========================================================= -->
      <div class="grid">
        <section id="stages">
          <h2>
            Canonical Sales Stages (1‚Äì14)
            <span class="status done">locked</span>
          </h2>
          <div class="body">
            <p class="note">
              Note: Stage 15 was dropped. PO Received implies Quote Approval is complete.
            </p>
            <table aria-label="stages">
              <thead>
                <tr>
                  <th style="width: 56px">#</th>
                  <th>Stage</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>1</td><td>Inquiry &amp; Lead Capture</td></tr>
                <tr><td>2</td><td>Research &amp; Discovery</td></tr>
                <tr><td>3</td><td>Quotation Preparation (includes quote sent)</td></tr>
                <tr><td>4</td><td>Quote Approval</td></tr>
                <tr><td>5</td><td>Purchase Order (PO) Received</td></tr>
                <tr><td>6</td><td>Order Processing</td></tr>
                <tr><td>7</td><td>Invoicing</td></tr>
                <tr><td>8</td><td>Payment Received</td></tr>
                <tr><td>9</td><td>Release Sent to Customer</td></tr>
                <tr><td>10</td><td>Release Received</td></tr>
                <tr><td>11</td><td>Delivery Preparation</td></tr>
                <tr><td>12</td><td>Delivery Set (shipped / in transit / tracking shared)</td></tr>
                <tr><td>13</td><td>Delivery Confirmed</td></tr>
                <tr><td>14</td><td>Post-Delivery Follow-up / Closeout</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <section id="airtable">
          <h2>
            Airtable Data Model (Single Table)
            <span class="status done">‚úÖ created</span>
          </h2>
          <div class="body">
            <p class="note">
              ‚úÖ Base: <strong>ProBox Sales Dashboard</strong> ‚Üí Table: <strong>Quotes</strong>. Single row per quote number.
            </p>
            <p>
              Stage columns are long text; stage cells contain cumulative ‚Äústage update‚Äù details text.
            </p>
            <!-- Existing Airtable schema content remains below in the document -->
            <p class="note">
              Jump: <a href="#cumulative">Cumulative Updates</a>
            </p>
          </div>
        </section>
      </div>

      <!-- =========================================================
           WORKFLOW + PROMPT + TASKS + NOTES
           (Existing sections appear below; we keep them intact but linkable)
           ========================================================= -->

      <section id="workflow" style="margin-top: 14px">
        <h2>
          System Choice (Final)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <table aria-label="system table">
            <thead>
              <tr>
                <th>Element</th>
                <th>System</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Orchestration</td>
                <td><strong>n8n</strong></td>
                <td>Owns triggers + workflow steps + retries + failure handling.</td>
              </tr>
              <tr>
                <td>Email (MVP)</td>
                <td><strong>Gmail</strong> via Gmail API/n8n Gmail trigger</td>
                <td>Tail-end implementation to validate pipeline quickly.</td>
              </tr>
              <tr>
                <td>Email (Production)</td>
                <td><strong>Outlook/M365</strong> via Microsoft Graph/n8n Microsoft trigger</td>
                <td>Swap connectors; downstream logic remains identical.</td>
              </tr>
              <tr>
                <td>LLM calls</td>
                <td><strong>n8n HTTP/OpenAI node</strong> (prompt tunable)</td>
                <td>
                  LLM produces strict JSON: quote identifier + detected events + stage effects +
                  optional extracted fields.
                </td>
              </tr>
              <tr>
                <td>System of record + UI</td>
                <td><strong>Airtable</strong> (Base + Interfaces)</td>
                <td>Read-only dashboard: grid + detail + timeline + admin reprocess.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section style="margin-top: 14px">
        <h2>
          n8n Node Naming Convention (Required)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <p>
            Every time we add a node, we must rename it immediately so the workflow is readable and
            debugging is fast.
          </p>
          <p><strong>Naming format</strong></p>
          <ul>
            <li><strong>Prefix</strong>: Source/Step type (Gmail / OpenAI / Airtable / Code / IF)</li>
            <li><strong>Verb</strong>: what it does (Build, Parse, Search, Merge, Update, Create)</li>
            <li><strong>Object</strong>: what it acts on (Email Packet, LLM JSON, Quote Row)</li>
          </ul>
          <p><strong>Examples (recommended)</strong></p>
          <ul>
            <li><span class="mono">Gmail Trigger - New Email</span></li>
            <li><span class="mono">Code - Build Email Packet</span></li>
            <li><span class="mono">OpenAI - Extract Stage Updates</span></li>
            <li><span class="mono">Code - Parse LLM JSON</span></li>
            <li><span class="mono">IF - Stop (Missing Quote ID)</span></li>
            <li><span class="mono">Airtable - Search Quote</span></li>
            <li><span class="mono">Code - Merge/Append Stage Updates</span></li>
            <li><span class="mono">IF - Record Exists?</span></li>
            <li><span class="mono">Airtable - Update Quote (Typecast ON)</span></li>
            <li><span class="mono">Airtable - Create Quote (Typecast ON)</span></li>
            <li><span class="mono">Code - Dedupe Mark Processed</span></li>
          </ul>
        </div>
      </section>

      <div class="grid" style="margin-top: 14px">
        <section>
          <h2>
            Airtable Data Model (Minimum ‚Äî Single Table)
            <span class="status done">‚úÖ created</span>
          </h2>
          <div class="body">
            <p class="note">
              ‚úÖ <strong>Status: Created</strong> - Base "ProBox Sales Dashboard" with table "Quotes" has
              been created with all fields listed below.
            </p>
            <p>
              The dashboard is a single Airtable grid. Each stage is a column, and each cell contains
              the best extracted "stage update" text (not just done/in-progress).
            </p>
            <ul>
              <li>
                <strong>Table: Quotes</strong> (one row per quote #)
                <ul>
                  <li><span class="mono">QuoteNumber</span> (primary key / primary field)</li>
                  <li><span class="mono">Customer</span> (optional)</li>
                  <li><span class="mono">ReceivedAt</span> (date/time; first time we saw this quote)</li>
                  <li><span class="mono">LastUpdatedAt</span> (date/time)</li>
                  <li><span class="mono">CurrentStage</span> (1‚Äì14, computed by n8n)</li>
                  <li>
                    <span class="mono">FinalStatus</span> (single select:
                    <span class="mono">open</span> |
                    <span class="mono">closed</span> |
                    <span class="mono">cancelled</span>)
                  </li>
                  <li><span class="mono">ClosedAt</span> (date/time; set once when FinalStatus becomes closed)</li>
                  <li><span class="mono">CancelledAt</span> (date/time; set once when FinalStatus becomes cancelled)</li>
                  <li>
                    <span class="mono">IsJustReceived</span> (formula/checkbox): true if ReceivedAt is within last 2 days
                  </li>
                  <li>
                    <span class="mono">ShowOnDashboard</span> (formula/checkbox): true if record should appear on dashboard
                    (open always shows; cancelled shows for 2 days; closed never shows)
                  </li>
                  <li>
                    <span class="mono">Inquiry &amp; Lead Capture</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Research &amp; Discovery</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Quotation Preparation</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Quote Approval</span> (long text)
                  </li>
                  <li>
                    <span class="mono">PO Received</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Order Processing</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Invoicing</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Payment Received</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Release Sent</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Release Received</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Delivery Preparation</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Delivery Set</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Delivery Confirmed</span> (long text)
                  </li>
                  <li>
                    <span class="mono">Post-Delivery Follow-up</span> (long text)
                  </li>
                  <li class="note">
                    Optional: add parallel single-select fields like <span class="mono">Inquiry Status</span>,
                    <span class="mono">Research Status</span>, etc. purely for coloring/filtering.
                  </li>
                </ul>
              </li>
            </ul>
            <p><strong>FinalStatus rule (deterministic):</strong></p>
            <ul>
              <li>
                <strong>closed</strong>: all 14 stage status fields are <span class="mono">done</span>
                (or, if you skip per-stage status fields, all 14 stage text columns are non-empty).
                When it becomes closed, set <span class="mono">ClosedAt</span> once.
              </li>
              <li>
                <strong>cancelled</strong>: set when an email indicates the quote/order is cancelled/withdrawn.
                Set <span class="mono">CancelledAt</span> once. Cancelled stays visible on the dashboard
                for 2 days, then drops off the active dashboard view (still retained in Airtable).
              </li>
              <li>
                <strong>open</strong>: default while the quote is being worked (regardless of stage).
              </li>
            </ul>
            <p><strong>Dashboard visibility (no extra workflow required)</strong></p>
            <ul>
              <li>
                <strong>IsJustReceived</strong> (formula): <span class="mono">DATETIME_DIFF(NOW(), ReceivedAt, 'days') &lt;= 2</span>
              </li>
              <li>
                <strong>ShowOnDashboard</strong> (formula): show open always; show cancelled only for 2 days; never show closed.
              </li>
              <li class="note">
                Recommended Airtable view for the dashboard: filter to <span class="mono">ShowOnDashboard = 1</span>.
              </li>
            </ul>
            <p class="note">
              Dedupe/reprocess: for v1, store processed message IDs in n8n workflow storage. If
              you ever want a durable audit history, add a second table later (‚ÄúMessages‚Äù or ‚ÄúEvents‚Äù),
              but it is not required for the single-grid dashboard.
            </p>
          </div>
        </section>

        <section>
          <h2>
            n8n Workflows (Minimum)
            <span class="status inprogress">in progress</span>
          </h2>
          <div class="body">
            <ul>
              <li>
                <strong>Workflow A: Ingest ‚Üí Extract ‚Üí Update Grid</strong>
                <ul>
                  <li>Trigger: New email in inbox (Gmail now, Outlook later)</li>
                  <li>Normalize: HTML‚Üítext, include thread context if available</li>
                  <li>LLM: extract strict JSON (quote # + which stage(s) to update + stage text)</li>
                  <li>Dedupe: skip if ProviderMessageId already processed</li>
                  <li>Write: upsert Quote row + update the stage column(s) with extracted text</li>
                  <li>Compute: update CurrentStage + LastUpdatedAt</li>
                </ul>
              </li>
              <li>
                <strong>Workflow B: Admin Reprocess</strong>
                <ul>
                  <li>Trigger: manual button/webhook</li>
                  <li>Input: time range or quote #</li>
                  <li>Action: re-fetch relevant emails, re-run extraction, update Airtable</li>
                </ul>
              </li>
              <li>
                <strong>Workflow C: Maintenance Sweep (optional)</strong>
                <ul>
                  <li>
                    Optional: if you prefer not to rely on Airtable formula fields for dashboard visibility, you can run a daily sweep.
                  </li>
                  <li class="note">
                    Current recommended approach: use Airtable formula fields (<span class="mono">ShowOnDashboard</span>) so no sweep is required.
                  </li>
                </ul>
              </li>
              <li>
                <strong>Workflow D: Failure Handling</strong>
                <ul>
                  <li>On error: write to ‚ÄúMessages‚Äù as failed + capture error text</li>
                  <li>Optional: notify via Slack/email</li>
                </ul>
              </li>
            </ul>
          </div>
        </section>
      </div>

      <section style="margin-top: 14px">
        <h2>
          Implementation Status & Summary
          <span class="status inprogress">in progress</span>
        </h2>
        <div class="body">
          <h3>‚úÖ Completed So Far (Today)</h3>
          <ul>
            <li>
              <strong>Airtable Base Created</strong>: "ProBox Sales Dashboard" with table "Quotes"
              <ul>
                <li>Primary field: <span class="mono">QuoteNumber</span> (Single line text)</li>
                <li>
                  Control fields: <span class="mono">Customer</span>, <span class="mono">ReceivedAt</span> (Date/time),
                  <span class="mono">LastUpdatedAt</span> (Date/time), <span class="mono">CurrentStage</span> (Number),
                  <span class="mono">FinalStatus</span> (Single select: open, closed, cancelled),
                  <span class="mono">ClosedAt</span> (Date/time), <span class="mono">CancelledAt</span> (Date/time),
                  <span class="mono">IsJustReceived</span> (Formula/Checkbox),
                  <span class="mono">ShowOnDashboard</span> (Formula/Checkbox)
                </li>
                <li>14 stage columns (all Long text): Inquiry & Lead Capture, Research & Discovery, Quotation Preparation, Quote Approval, PO Received, Order Processing, Invoicing, Payment Received, Release Sent, Release Received, Delivery Preparation, Delivery Set, Delivery Confirmed, Post-Delivery Follow-up</li>
              </ul>
            </li>
            <li>
              <strong>Airtable Personal Access Token Created</strong>: "n8n-probox-dashboard" with scopes data.records:read, data.records:write
            </li>
            <li>
              <strong>n8n Workflow Structure Complete</strong>: All nodes connected end-to-end
              <ul>
                <li><strong>Gmail Trigger</strong> ‚Üí Build Email Packet ‚Üí Code - Check Dedupe ‚Üí Message a model ‚Üí Parse LLM JSON ‚Üí If (stop check)</li>
                <li><strong>If (false path)</strong> ‚Üí Prepare Airtable Fields ‚Üí Search records ‚Üí Code - Preserve Fields ‚Üí Record Exists</li>
                <li><strong>Record Exists (true path)</strong> ‚Üí Create Quote ‚Üí Code - Mark Processed</li>
                <li><strong>Record Exists (false path)</strong> ‚Üí Merge/Append Stage Updates ‚Üí Update Quote ‚Üí Code - Mark Processed</li>
                <li><strong>All nodes properly named</strong> and connected</li>
                <li><strong>Search records</strong>: alwaysOutputData: true enabled (so workflow continues when no record found)</li>
                <li><strong>Record Exists IF</strong>: checks if $json.id is empty (true = create, false = update)</li>
                <li><strong>Typecast enabled</strong>: ON in Create Quote and Update Quote nodes</li>
              </ul>
            </li>
            <li>
              <strong>Build Email Packet</strong>: Working correctly, outputs provider_message_id and email_text with From + Subject + Body
            </li>
            <li>
              <strong>Code - Preserve Fields</strong>: Added to preserve data from Prepare Airtable Fields when Search records finds nothing, so Create Quote can access prepared fields
            </li>
            <li>
              <strong>Requirements document updated</strong>: Quote identifier format changed to numeric-only (e.g., "330519" not "INQ 330519")
            </li>
          </ul>

          <h3>üìã Current n8n Workflow Topology (Node List in Order)</h3>
          <p class="note"><strong>EXACT NODE NAMES (from Dashboard.json):</strong> Use these exact names when referencing nodes in code.</p>
          <ol>
            <li><strong>Gmail Trigger</strong> (Trigger: new email)</li>
            <li><strong>Build Email Packet</strong> (Code node: outputs provider_message_id + email_text)</li>
            <li><strong>Check Dedupe</strong> (Code node: currently passes through, dedupe logic pending)</li>
            <li><strong>Message a model</strong> (OpenAI node: extracts quote identifier + stage updates from email_text)</li>
            <li><strong>Parse LLM JSON</strong> (Code node: parses OpenAI output, outputs primary_quote_identifier + stage_updates[] + stop flag)</li>
            <li><strong>If</strong> (IF node: if stop === true ‚Üí stop; if stop === false ‚Üí continue)</li>
            <li><strong>Prepare Airtable Fields </strong> (Code node: NOTE TRAILING SPACE! transforms stage_updates[] to Airtable field mappings, computes CurrentStage/FinalStatus)</li>
            <li><strong>Search records</strong> (Airtable node: searches Quotes table by QuoteNumber, alwaysOutputData: true)</li>
            <li><strong>Preserve Fields</strong> (Code node: merges Search result with Prepare Airtable Fields data so Create Quote can access fields)</li>
            <li><strong>If1</strong> (IF node: if $json.id is empty ‚Üí TRUE path to Create; if $json.id exists ‚Üí FALSE path to Update)</li>
            <li><strong>Create a record</strong> (Airtable node: TRUE path, creates new record)</li>
            <li><strong>Code in JavaScript</strong> (Code node: FALSE path, merges new updates with existing record fields - this is "Merge/Append Stage Updates")</li>
            <li><strong>Update record</strong> (Airtable node: FALSE path, updates existing record with merged fields)</li>
            <li><strong>Mark Processed</strong> (Code node: receives from both Create and Update paths, currently passes through)</li>
          </ol>
          <p class="note"><strong>CRITICAL:</strong> "Prepare Airtable Fields " has a trailing space. Always use exact node names when referencing in code: <code>$node["Prepare Airtable Fields "]</code></p>

          <h4>Preserve Fields Node Code (EXACT - Copy/Paste)</h4>
          <pre>// Preserve data from Prepare Airtable Fields when Search records finds nothing
// Search records returns array of records: [{id: "...", fields: {...}}, ...]
// When alwaysOutputData: true and nothing found, it returns the input data

// Search records can return an array or a single item - always take first
const searchResults = Array.isArray($json) ? $json : [$json];
const searchRecord = searchResults[0] || null;

// Check if this is an Airtable record (has id property) or input data (has QuoteNumber but no id)
const isAirtableRecord = searchRecord && searchRecord.id;

if (isAirtableRecord) {
  // Record exists - return the full Airtable record structure
  return {
    json: searchRecord
  };
} else {
  // No record found - Search records returned input data (from Prepare Airtable Fields)
  // Use that data with explicit null id
  return {
    json: {
      ...searchRecord, // This contains the prepared fields from Prepare Airtable Fields
      id: null // explicitly no id so If1 can check for empty
    }
  };
}</pre>

          <h3>üöß In Progress / Next Steps (Tomorrow)</h3>
          <ul>
            <li>
              <strong>Fix Create Quote field mappings</strong>: Currently showing literal expressions ({{$json.primary_qu...) instead of values. Need to map all fields using correct references: <code>{{ $('Prepare Airtable Fields ').item.json.QuoteNumber }}</code> for QuoteNumber, and similar for all other fields (LastUpdatedAt, CurrentStage, FinalStatus, ReceivedAt, all 14 stage columns)
            </li>
            <li>
              <strong>Fix Message a model prompt</strong>: Still not extracting quote "551308" from email thread. Need to test with simpler email first, then refine prompt for multi-email threads. Consider adding examples or trying different model.
            </li>
            <li>
              <strong>Test end-to-end with working quote extraction</strong>: Once Create Quote mappings are fixed and quote extraction works, send test email and verify entire workflow creates/updates Airtable correctly
            </li>
            <li>
              <strong>Verify cumulative append</strong>: Send second email for same quote and confirm stage cell appends with timestamp divider (no deletion of existing text)
            </li>
            <li>
              <strong>Implement dedupe storage</strong>: Store processed provider_message_id in n8n workflow storage so same email can't process twice (Check Dedupe currently just passes through)
            </li>
            <li>
              <strong>Gmail Filter</strong>: Add subject/from filter to exclude system emails (like n8n access notifications)
            </li>
          </ul>

          <h3>üìã Remaining Work (After Core Flow Works)</h3>
          <ul>
            <li>Dedupe logic (check ProviderMessageId in n8n storage before processing)</li>
            <li>Dashboard visibility via Airtable formula field (ShowOnDashboard) + view filters (no sweep required)</li>
            <li>Admin reprocess workflow (re-run extraction for time range)</li>
            <li>Airtable Interface: Grid view with color coding (green=done, blue=in_progress, red=not_started)</li>
            <li>Outlook/M365 migration (swap Gmail trigger ‚Üí Outlook trigger)</li>
          </ul>

          <h3>‚úÖ What is Working End-to-End</h3>
          <ul>
            <li>
              <strong>Workflow structure</strong>: All nodes connected correctly, no duplicate paths
            </li>
            <li>
              <strong>Duplicate prevention</strong>: Fixed - workflow now creates single record when quote doesn't exist (removed duplicate connection from Search records to Record Exists)
            </li>
            <li>
              <strong>Record Exists logic</strong>: IF node correctly routes to Create (when id is empty) or Update (when id exists) paths
            </li>
            <li>
              <strong>Preserve Fields</strong>: Correctly extracts id from Airtable records and preserves prepared fields when no record found
            </li>
            <li>
              <strong>Prepare Airtable Fields</strong>: Outputs all required fields including all 14 stage columns and ReceivedAt
            </li>
            <li>
              <strong>Search records</strong>: Finds existing records by QuoteNumber, returns empty item when nothing found (alwaysOutputData: true)
            </li>
            <li>
              <strong>Email processing</strong>: Gmail trigger ‚Üí Build Email Packet ‚Üí Check Dedupe ‚Üí Message a model ‚Üí Parse LLM JSON flow works
            </li>
          </ul>

          <h3>üéØ Current Blockers / Questions</h3>
          <ul>
            <li>
              <strong>BLOCKER: Create Quote field mappings showing literal expressions</strong>: Airtable is receiving expressions like {{$json.primary_qu... instead of actual values. Need to fix all field mappings to use correct node references: <code>{{ $('Prepare Airtable Fields ').item.json.FieldName }}</code>
            </li>
            <li>
              <strong>BLOCKER: Message a model not extracting quote identifiers from email threads</strong>: Returns empty primary_quote_identifier for email thread with "INQ 551308" in subject. Prompt updated today but still not working. May need to:
              <ul>
                <li>Test with simpler single-email first to verify extraction works</li>
                <li>Add examples to prompt showing how to extract from email threads</li>
                <li>Consider if email_text format (with multiple emails in thread) is confusing the model</li>
                <li>Try different model (gpt-4 vs gpt-4.1-mini) or add few-shot examples</li>
              </ul>
            </li>
            <li>
              <strong>Dedupe logic not implemented</strong>: Check Dedupe and Mark Processed nodes exist but just pass through. Need to add n8n workflow storage logic
            </li>
            <li>FinalStatus "closed" rule can be tuned later (currently based on stage columns being non-empty)</li>
          </ul>

          <h3>üìê Canonical Processing Architecture (Holistic v2)</h3>
          <p class="note">
            This is the complete, holistic architecture for processing emails from the sales inbox.
            It handles multiple emails per run, full email threads, comprehensive data extraction, and proper deduplication.
          </p>

          <p><strong>Core invariants</strong></p>
          <ul>
            <li><strong>One quote = one Airtable row</strong> keyed by <span class="mono">QuoteNumber</span>.</li>
            <li><strong>Emails are deltas</strong>: each email may update 0‚ÄìN stages with comprehensive data.</li>
            <li><strong>Cumulative merge</strong>: never delete prior data; append new data with timestamp divider (avoid exact duplicates).</li>
            <li><strong>No duplicates</strong>: dedupe by <span class="mono">provider_message_id</span> stored in <span class="mono">ProcessedEmails</span> table.</li>
            <li><strong>Full thread processing</strong>: extract and process the ENTIRE email thread (all responses), not just the latest email.</li>
            <li><strong>Comprehensive extraction</strong>: extract ALL data from emails (all bullet points, all details, all fields), not just the 14 stage names.</li>
            <li><strong>Existing data check</strong>: before updating, check if data already exists in Airtable; only add missing data, never overwrite existing.</li>
            <li>
              <strong>Drop off when done/cancelled</strong>: the "active dashboard" is an Airtable view filtered to
              <span class="mono">ShowOnDashboard = 1</span> (formula field).
            </li>
          </ul>

          <p><strong>Email ingestion strategy (5-minute window)</strong></p>
          <ul>
            <li><strong>Time-based processing</strong>: Check emails received in the last 5 minutes (not just "new" emails).</li>
            <li><strong>Batch processing</strong>: Handle multiple emails in one workflow run (not one email at a time).</li>
            <li><strong>Deduplication check</strong>: For each email in the 5-minute window, check <span class="mono">ProcessedEmails</span> table to see if <span class="mono">provider_message_id</span> already exists.</li>
            <li><strong>Filter unprocessed</strong>: Only process emails that are NOT in <span class="mono">ProcessedEmails</span> table.</li>
            <li><strong>Full thread extraction</strong>: For each email, extract the ENTIRE email thread (all 5 responses if it's a thread, not just the latest).</li>
          </ul>

          <p><strong>Canonical node flow (n8n) - Holistic v2</strong></p>
          <pre><code>1) Schedule Trigger (every 5 minutes)
   OR Gmail Trigger (configured to search last 5 minutes)

2) Code - Get Emails from Last 5 Minutes
   - Query Gmail API for emails received in last 5 minutes
   - Returns: array of email objects { id, threadId, receivedAt, ... }

3) Code - Filter Already Processed
   - For each email, check ProcessedEmails table in Airtable
   - Filter: only keep emails where provider_message_id NOT in ProcessedEmails
   - Output: array of unprocessed emails

4) Loop Over Unprocessed Emails (n8n Split In Batches or For Each)
   For each unprocessed email:

   5) Code - Build Full Email Thread Packet
      - Fetch the ENTIRE email thread (all responses in thread)
      - Extract: provider_message_id, full_thread_text (all emails in thread)
      - Output: { provider_message_id, full_thread_text }

   6) OpenAI - Message a model
      - Input: full_thread_text (entire thread, not just latest email)
      - Prompt: Extract comprehensive data (all details, all bullet points, all fields)
      - Output: strict JSON with comprehensive extracted data

   7) Code - Parse LLM JSON
      - Output: { primary_quote_identifier, comprehensive_data, stage_updates[], stop }

   8) IF stop === true
      TRUE: skip this email, continue to next
      FALSE: continue

   9) Airtable - Search records (Quotes)
      Filter: {QuoteNumber} = "primary_quote_identifier"
      Output: 0 records or 1 record (existing)

   10) Code - Check Existing Data & Merge
       - Read existing Airtable record (if any)
       - For each field in comprehensive_data:
         - If field already exists in Airtable ‚Üí skip (don't overwrite)
         - If field is missing ‚Üí add it
       - For each stage_update:
         - mergeCell(existing, new) => append with timestamp divider (avoid exact duplicates)
       - Compute CurrentStage from highest stage that has content
       - Compute FinalStatus (cancelled, closed, or open)
       - Output: { recordId (nullable), fields (object) }

   11) IF recordId exists?
       TRUE: Airtable Update record (Typecast ON)
       FALSE: Airtable Create record (Typecast ON)

   12) Airtable - Create record (ProcessedEmails)
       - Only after successful Create/Update
       - Store: provider_message_id, processed_at, quote_number
       - This marks the email as "processed" for future runs

End Loop

13) Done - All unprocessed emails from last 5 minutes have been processed</code></pre>

          <p><strong>Data extraction requirements</strong></p>
          <ul>
            <li><strong>Extract ALL data</strong>: Not just the 14 stage names. Extract all bullet points, all details, all fields mentioned in the email thread.</li>
            <li><strong>Comprehensive fields</strong>: Customer names, addresses, phone numbers, PO numbers, invoice numbers, tracking numbers, dates, amounts, quantities, locations, special requirements, etc.</li>
            <li><strong>Full thread context</strong>: Process the ENTIRE email thread (all 5 responses if it's a thread). The LLM must see all responses to extract complete information.</li>
            <li><strong>Stage updates</strong>: Identify which of the 14 stages are updated, and extract all relevant details for each stage.</li>
          </ul>

          <p><strong>Deduplication strategy</strong></p>
          <ul>
            <li><strong>ProcessedEmails table</strong>: Airtable table with fields: <span class="mono">provider_message_id</span> (unique), <span class="mono">processed_at</span> (date/time), <span class="mono">quote_number</span> (text).</li>
            <li><strong>Check before processing</strong>: Before processing any email, check if its <span class="mono">provider_message_id</span> exists in <span class="mono">ProcessedEmails</span> table.</li>
            <li><strong>Mark after success</strong>: Only after successful Airtable write (Create or Update), insert the <span class="mono">provider_message_id</span> into <span class="mono">ProcessedEmails</span> table.</li>
            <li><strong>No reprocessing</strong>: Once an email is in <span class="mono">ProcessedEmails</span>, it will never be processed again (unless manually deleted from table).</li>
          </ul>

          <p><strong>Setup: Create ProcessedEmails table in Airtable</strong></p>
          <ol>
            <li>In Airtable base "ProBox Sales Dashboard", create a new table named <span class="mono">ProcessedEmails</span></li>
            <li>Add field: <span class="mono">provider_message_id</span> (Single line text, make it unique if possible)</li>
            <li>Add field: <span class="mono">processed_at</span> (Date/time)</li>
            <li>Add field: <span class="mono">quote_number</span> (Single line text)</li>
            <li>Note the table ID (you'll need it when importing the workflow JSON)</li>
          </ol>

          <p><strong>Workflow JSON: Credential Setup</strong></p>
          <p class="note">
            The workflow JSON file (<span class="mono">Dashboard-Holistic-v2.json</span>) has credential IDs embedded from the original export.
            When importing to the <strong>same n8n instance</strong>, credentials should auto-map and you won't get prompts.
            If importing to a different n8n instance, you'll need to map credentials manually (n8n will prompt you).
          </p>
          <p><strong>Credential names used in JSON:</strong></p>
          <ul>
            <li>Gmail: <span class="mono">"Gmail account"</span></li>
            <li>OpenAI: <span class="mono">"OpenAi account"</span></li>
            <li>Airtable: <span class="mono">"Airtable Personal Access Token account"</span></li>
          </ul>
          <p class="note">
            If you need to create new credentials, use these exact names so the workflow can find them automatically.
          </p>

          <p><strong>How we handle all email cases (explicit)</strong></p>
          <ul>
            <li><strong>Email has new info but only for 1 stage</strong>: only that stage column changes (append). All other data preserved.</li>
            <li><strong>Email has multiple stage updates</strong>: multiple columns update in one run. All comprehensive data extracted and merged.</li>
            <li><strong>Email is shorter / missing fields</strong>: we do not clear anything; untouched columns stay as-is. Only missing data is added.</li>
            <li><strong>Email is a correction</strong>: append with a "CORRECTION:" prefix and do not delete old text.</li>
            <li><strong>Email is a reschedule</strong>: append new dates; do not erase old dates.</li>
            <li><strong>Email is cancellation</strong>: set FinalStatus=cancelled, set CancelledAt once; keep active for 2 days then drop off.</li>
            <li><strong>Email indicates completion</strong>: later stages may become populated; when all 14 are populated ‚Üí FinalStatus becomes closed and it "drops off" the active view.</li>
            <li><strong>Email has no usable quote identifier</strong>: skip this email, continue to next email in batch.</li>
            <li><strong>Email thread with 5 responses</strong>: extract and process ALL 5 responses as one complete thread. LLM sees entire conversation history.</li>
            <li><strong>Multiple emails in 5-minute window</strong>: process all unprocessed emails in batch. Each email checked against ProcessedEmails before processing.</li>
            <li><strong>Data already exists in Airtable</strong>: check existing data before updating. If data already exists, skip adding it (don't overwrite). Only add missing data.</li>
          </ul>
        </div>
      </section>

      <section id="tasks" style="margin-top: 14px">
        <h2>
          Build Task List (with Status)
          <span class="status inprogress">in progress</span>
        </h2>
        <div class="body">
          <p class="note">
            This list is intentionally concrete so implementation doesn‚Äôt drift.
          </p>
          <table aria-label="tasks">
            <thead>
              <tr>
                <th style="width: 140px">Status</th>
                <th>Task</th>
                <th style="width: 220px">Owner / Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="status done">done</span></td>
                <td>Create Airtable Base: single table "Quotes" with stage-name columns</td>
                <td>‚úÖ Base created; all 20 fields added (6 control + 14 stage columns)</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>Create Airtable Personal Access Token for n8n</td>
                <td>‚úÖ Token "n8n-probox-dashboard" created with read/write scopes</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n Workflow structure: All nodes connected end-to-end (Gmail ‚Üí Build Email Packet ‚Üí Check Dedupe ‚Üí Message a model ‚Üí Parse JSON ‚Üí If ‚Üí Prepare Fields ‚Üí Search ‚Üí Preserve Fields ‚Üí Record Exists ‚Üí Create/Update ‚Üí Mark Processed)</td>
                <td>‚úÖ Complete workflow topology with all branches; nodes properly named</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n Code Node: Prepare Airtable Fields (transforms stage_updates[] to Airtable field mappings)</td>
                <td>‚úÖ Maps stage_name to column names, computes CurrentStage/FinalStatus, outputs all fields</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n Code Node: Code - Preserve Fields (preserves Prepare Airtable Fields data when Search finds nothing)</td>
                <td>‚úÖ Merges prepared fields with search result so Create Quote can access data</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n Code Node: Merge/Append Stage Updates (cumulative merge logic)</td>
                <td>‚úÖ Appends new stage text with timestamp divider, computes CurrentStage/FinalStatus</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n Airtable Node: Search records with alwaysOutputData: true</td>
                <td>‚úÖ Finds existing records by QuoteNumber; outputs empty item when nothing found</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>n8n IF Node: Record Exists (checks if $json.id is empty)</td>
                <td>‚úÖ TRUE path ‚Üí Create Quote, FALSE path ‚Üí Merge/Append ‚Üí Update Quote. Fixed: Enabled "Convert types where required", removed duplicate connection from Search records</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>Fix duplicate record creation issue</td>
                <td>‚úÖ Fixed: Removed direct connection from "Search records" to "Record Exists". Now Record Exists only receives processed data from "Preserve Fields"</td>
              </tr>
              <tr>
                <td><span class="status done">done</span></td>
                <td>Prepare Airtable Fields: Output all 14 stage fields + ReceivedAt</td>
                <td>‚úÖ Updated code to ensure all stage fields are present in output (even if empty) and ReceivedAt is set for new records</td>
              </tr>
              <tr>
                <td><span class="status inprogress">in progress</span></td>
                <td>Fix Message a model prompt: Extract quote identifiers (numeric only, e.g., "551308")</td>
                <td>‚ö†Ô∏è BLOCKER: Not extracting from email threads. Prompt updated to remove INQ assumption and improve context. Need to test with simpler email first, then add thread-handling examples.</td>
              </tr>
              <tr>
                <td><span class="status inprogress">in progress</span></td>
                <td>n8n Airtable Node: Create Quote field mappings (QuoteNumber, LastUpdatedAt, CurrentStage, FinalStatus, ReceivedAt, all 14 stage columns)</td>
                <td>‚ö†Ô∏è BLOCKER: Field mappings showing literal expressions ({{$json.primary_qu...) instead of values. Need to use: <code>{{ $('Prepare Airtable Fields ').item.json.QuoteNumber }}</code> for all fields</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Test end-to-end: real email with quote identifier ‚Üí Airtable upsert</td>
                <td>BLOCKED: Waiting for Message a model to extract quote identifiers correctly</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Dedupe logic: Implement storage in Code - Check Dedupe and Code - Mark Processed</td>
                <td>Nodes exist but just pass through; need to add n8n workflow storage logic</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Gmail filter: exclude system/notification emails</td>
                <td>Add subject/from filter to Gmail Trigger</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Design Airtable Interfaces: Grid with color coding</td>
                <td>Green=done, blue=in_progress, red=not_started</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Dashboard visibility: Airtable formula (ShowOnDashboard) + view filter</td>
                <td>Cancelled stays visible 2 days, then drops off via formula; closed drops off immediately</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>n8n Workflow B: Admin reprocess by time range or quote #</td>
                <td>Re-run extraction and recompute stage</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>n8n Workflow D: failure logging + retry + notification</td>
                <td>Optional for v1; start with n8n error workflow</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>Outlook/M365 migration plan: swap trigger + message fetch nodes</td>
                <td>Keep same downstream schema</td>
              </tr>
              <tr>
                <td><span class="status todo">todo</span></td>
                <td>UAT: validate stage updates across sample threads</td>
                <td>Iterate prompt only</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="notes" style="margin-top: 14px">
          <h2>
            Things to Remember (Don‚Äôt Forget)
            <span class="status done">locked</span>
          </h2>
          <div class="body">
            <p class="note" style="background: #fff3cd; padding: 8px; border-left: 4px solid #ffc107;">
              <strong>Instruction style (CRITICAL):</strong> User is NOT a developer. All instructions must be:
              <ul>
                <li><strong>ONE step at a time</strong> (not multiple steps in one response)</li>
                <li><strong>Click-by-click detail</strong> (e.g., "Click the 'Settings' tab at the top of the node panel", not "go to settings")</li>
                <li><strong>No assumptions</strong> (don't say "configure the node" - say exactly which field to click, what dropdown to open, what value to type)</li>
                <li><strong>Show exact UI elements</strong> (button names, tab names, field labels as they appear on screen)</li>
                <li><strong>Wait for confirmation</strong> before giving the next step</li>
              </ul>
              Do NOT use phrases like "add a node", "configure it", "set it up" - instead say "Click the + button, type 'Code' in the search box, click 'Code' node, drag it between X and Y nodes".
            </p>
          <ul>
            <li>
              <strong>Don‚Äôt over-engineer rules</strong>: emails are messy; LLM interpretation will
              evolve via prompt tuning.
            </li>
            <li>
              <strong>No required fields</strong>: all extracted details are optional enrichment.
            </li>
            <li>
              <strong>PO received implies approval</strong>: stage 5 implies stage 4 is complete.
            </li>
            <li>
              <strong>No dashboard links back to source emails/docs</strong>: not required for v1.
            </li>
            <li>
              <strong>No drill-down</strong>: the grid is the dashboard; each stage cell contains the
              latest extracted details text.
            </li>
            <li>
              <strong>Dedupe is still mandatory</strong>: store ProviderMessageId to avoid
              double-processing.
            </li>
            <li>
              <strong>FinalStatus lifecycle</strong>: <span class="mono">open</span> until
              <span class="mono">closed</span> or <span class="mono">cancelled</span>.
              ‚ÄúJust received‚Äù is a <em>derived indicator</em> (see <span class="mono">IsJustReceived</span> formula),
              not a status that n8n has to maintain.
            </li>
            <li>
              <strong>Closure rule</strong>: mark <span class="mono">FinalStatus=closed</span> only when
              all 14 stages are done; set <span class="mono">ClosedAt</span> once.
            </li>
            <li>
              <strong>n8n coding choice</strong>: use <span class="mono">Code in JavaScript</span>
              (simpler than Python for n8n beginners).
            </li>
            <li>
              <strong>Design for Gmail ‚Üí Outlook swap</strong>: keep a connector abstraction in n8n
              (same downstream schema).
            </li>
            <li>
              <strong>Keep the grid deterministic</strong>: compute <span class="mono">CurrentStage</span>,
              <span class="mono">FinalStatus</span>, and <span class="mono">ClosedAt</span> from the stage
              statuses/columns, not from manual edits.
            </li>
          </ul>
        </div>
      </section>

      <section id="prompt" style="margin-top: 14px">
        <h2>
          Prompt Contract (High Level)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <p>
            The prompt can change, but the output contract must stay stable so Airtable and the grid
            never break. Output must identify the quote and provide stage updates as text.
          </p>
          <pre>{
  "primary_quote_identifier": "330519",
  "stage_updates": [
    {
      "stage_name": "PO Received",
      "cell_text": "‚úÖ PO received: PO-8831\\nQty: 4x 40HC\\nShip-to: Phoenix, AZ"
    }
  ]
}</pre>
          <p class="note">
            <strong>Quote identifier format:</strong> Extract only the numeric part (e.g., "23456000", "330519", "104892", "551308").
            Quote identifiers are numeric-only and can appear anywhere in the email (Subject line, body, etc.).
            Extract the numeric value only, without any prefixes or text.
          </p>
          <p class="note">
            Enforce JSON validity in n8n before writing to Airtable.
          </p>
        </div>
      </section>

      <section style="margin-top: 14px">
        <h2>
          n8n Workflow A (Step-by-step)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <p>
            This is the beginner-friendly build order for the core workflow:
            <strong>Gmail Trigger ‚Üí Code (email packet) ‚Üí LLM ‚Üí Airtable update</strong>.
          </p>

          <p><strong>Node 1: Gmail Trigger</strong></p>
          <ul>
            <li>Use the Gmail trigger that fires on new incoming emails.</li>
            <li>Start broad (no complex filters). You can filter later once it works end-to-end.</li>
          </ul>

          <p><strong>Node 2: Code in JavaScript ‚Äî Build Email Packet</strong></p>
          <ul>
            <li>Select <span class="mono">Code in JavaScript</span> (not Python).</li>
            <li>
              Set Mode to <strong>Run once for each item</strong> (each email is one item).
            </li>
            <li>Goal: output two stable fields for downstream nodes:</li>
            <ul>
              <li><span class="mono">provider_message_id</span> (dedupe key)</li>
              <li><span class="mono">email_text</span> (From + Subject + Body)</li>
            </ul>
          </ul>

          <pre>// n8n Code node (JavaScript) ‚Äî Run once for each item
function stripHtml(html) {
  return String(html || "").replace(/&lt;[^&gt;]*&gt;/g, " ").replace(/\s+/g, " ").trim();
}

const provider_message_id =
  $json.id ||
  $json.messageId ||
  $json.internalId ||
  $json.threadId ||
  $json.historyId ||
  "";

const from =
  $json.from?.email ||
  $json.from ||
  $json.sender ||
  $json.headers?.From ||
  "";

const subject =
  $json.subject ||
  $json.headers?.Subject ||
  "";

const bodyPlain =
  $json.textPlain ||
  $json.text ||
  $json.body ||
  $json.snippet ||
  "";

const bodyHtml = $json.textHtml || $json.html || "";

const bodyText = bodyPlain && String(bodyPlain).trim().length &gt; 0
  ? String(bodyPlain).trim()
  : stripHtml(bodyHtml);

const email_text = `From: ${from}\nSubject: ${subject}\n\n${bodyText}`.trim();

return {
  json: {
    provider_message_id,
    email_text,
  },
};</pre>

          <p class="note">
            After you click ‚ÄúExecute workflow‚Äù, open the Code node output and confirm you see
            <span class="mono">provider_message_id</span> and <span class="mono">email_text</span>.
          </p>

          <p><strong>Node 3: LLM Call</strong></p>
          <ul>
            <li>Use HTTP Request (or OpenAI node) to send <span class="mono">email_text</span>.</li>
            <li>Enforce strict JSON output matching the Prompt Contract section.</li>
          </ul>

          <p><strong>Node 4+: Airtable Update</strong></p>
          <ul>
            <li>Find/Create the quote row by <span class="mono">QuoteNumber</span>.</li>
            <li>Update the stage-name column(s) with the returned <span class="mono">cell_text</span>.</li>
            <li>Recompute <span class="mono">CurrentStage</span> and <span class="mono">FinalStatus</span>.</li>
            <li>Set <span class="mono">ReceivedAt</span> on first insert; set <span class="mono">ClosedAt</span> once when closed.</li>
          </ul>
        </div>
      </section>

      <section id="cumulative" style="margin-top: 14px">
        <h2>
          Cumulative Updates (Core Behavior)
          <span class="status done">locked</span>
        </h2>
        <div class="body">
          <p>
            The dashboard is a cumulative tracker. Each new email may update only some stages. The system
            must <strong>never create duplicate quote rows</strong> and must <strong>never delete prior stage details</strong>.
            Instead, it merges/append updates over time.
          </p>

          <p><strong>Rules</strong></p>
          <ul>
            <li>
              <strong>Single row per quote</strong>: identify the quote (quote # / inquiry #) and always upsert
              into the same Airtable record keyed by <span class="mono">QuoteNumber</span>.
            </li>
            <li>
              <strong>Partial updates are normal</strong>: an email can update 1 stage, many stages, or none.
              Only touched stages should change.
            </li>
            <li>
              <strong>Don‚Äôt overwrite with empties</strong>: if an update does not mention a stage, do nothing to that
              stage column (leave existing text untouched).
            </li>
            <li>
              <strong>Append instead of replace (default)</strong>: when a stage already has content and a new email adds more,
              append the new text under a timestamp divider (unless it is clearly a correction that should replace).
            </li>
            <li>
              <strong>No double-processing</strong>: use <span class="mono">provider_message_id</span> for dedupe (store in n8n
              workflow static data or in a hidden Airtable field like <span class="mono">SeenMessageIds</span>).
            </li>
          </ul>

          <p><strong>Implementation change required in n8n</strong></p>
          <ul>
            <li>
              Before calling the LLM, fetch the existing Airtable row for this quote (if it exists), and include a snapshot of
              current stage cell contents in the LLM prompt. This makes the model produce a <strong>delta</strong> instead of
              rewriting.
            </li>
            <li>
              After LLM returns <span class="mono">stage_updates[]</span>, run a merge step that combines:
              <span class="mono">existing_cell_text</span> + <span class="mono">new_cell_text</span>.
            </li>
          </ul>

          <p><strong>Recommended LLM output for cumulative merging</strong></p>
          <pre>{
  "primary_quote_identifier": "104892",
  "stage_updates": [
    {
      "stage_name": "Inquiry & Lead Capture",
      "cell_text": "‚úÖ Received pallet freight request from Chicago IL to Dallas; 6 pallets..."
    }
  ]
}</pre>
          <p class="note">
            The prompt can evolve, but the system behavior is stable: only update stages returned by the LLM, and preserve existing
            stage text by default (append with timestamp).
          </p>
        </div>
      </section>
    </main>
  </body>
</html>


